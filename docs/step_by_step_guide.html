<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-02-22">

<title>step_by_step_guide – FOSSILPOL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">FOSSILPOL</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">General Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./step_by_step_guide.html" aria-current="page"> 
<span class="menu-text">A step-by-step guide</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./get_in_touch.html"> 
<span class="menu-text">Get in touch!</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./other_materials.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/HOPE-UIB-BIO/FOSSILPOL-workflow" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-step-by-step-guide-to-data-processing-with-fossilpol" id="toc-a-step-by-step-guide-to-data-processing-with-fossilpol" class="nav-link active" data-scroll-target="#a-step-by-step-guide-to-data-processing-with-fossilpol">A step-by-step guide to data processing with FOSSILPOL</a>
  <ul>
  <li><a href="#figure-1figure-1" id="toc-figure-1figure-1" class="nav-link" data-scroll-target="#figure-1figure-1">Figure 1<img src="figures/Workflow complete - 600ppi.png" class="img-fluid" alt="Figure 1"></a></li>
  <li><a href="#data-input" id="toc-data-input" class="nav-link" data-scroll-target="#data-input">Data input</a>
  <ul>
  <li><a href="#figure-2figure-2" id="toc-figure-2figure-2" class="nav-link" data-scroll-target="#figure-2figure-2">Figure 2<img src="figures/Workflow_Detailed.png" class="img-fluid" alt="Figure 2"></a></li>
  </ul></li>
  <li><a href="#data-storage" id="toc-data-storage" class="nav-link" data-scroll-target="#data-storage">Data storage</a>
  <ul>
  <li><a href="#code-block-3" id="toc-code-block-3" class="nav-link" data-scroll-target="#code-block-3">Code block 3</a></li>
  </ul></li>
  <li><a href="#data-processing" id="toc-data-processing" class="nav-link" data-scroll-target="#data-processing">Data processing</a>
  <ul>
  <li><a href="#i.-data-sourcing-01_neotoma_source" id="toc-i.-data-sourcing-01_neotoma_source" class="nav-link" data-scroll-target="#i.-data-sourcing-01_neotoma_source"><span class="text-background-blue bold">I. Data sourcing</span>: <code>/01_Neotoma_source/</code></a>
  <ul>
  <li><a href="#download_neotoma.r" id="toc-download_neotoma.r" class="nav-link" data-scroll-target="#download_neotoma.r"><em>01_Download_neotoma.R</em></a></li>
  <li><a href="#extract_samples.r" id="toc-extract_samples.r" class="nav-link" data-scroll-target="#extract_samples.r"><em>02_Extract_samples.R</em></a></li>
  <li><a href="#filter_dep_env.r" id="toc-filter_dep_env.r" class="nav-link" data-scroll-target="#filter_dep_env.r"><em>03_Filter_dep_env.R</em></a></li>
  <li><a href="#extract_chron_control_tables.r" id="toc-extract_chron_control_tables.r" class="nav-link" data-scroll-target="#extract_chron_control_tables.r"><em>04_Extract_chron_control_tables.R</em></a></li>
  <li><a href="#extract_raw_pollen_data.r" id="toc-extract_raw_pollen_data.r" class="nav-link" data-scroll-target="#extract_raw_pollen_data.r"><em>05_Extract_raw_pollen_data.R</em></a>
  <ul class="collapse">
  <li><a href="#table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma" id="toc-table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma" class="nav-link" data-scroll-target="#table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma"><strong>Table 1. Ecological groups assigned to pollen taxa as defined in Neotoma</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ii.-data-sourcing-02_other_source" id="toc-ii.-data-sourcing-02_other_source" class="nav-link" data-scroll-target="#ii.-data-sourcing-02_other_source"><span class="text-background-blue bold">II. Data sourcing</span>: <code>/02_Other_source/</code></a>
  <ul>
  <li><a href="#note-on-other-data-sourcing" id="toc-note-on-other-data-sourcing" class="nav-link" data-scroll-target="#note-on-other-data-sourcing">Note on other data sourcing</a></li>
  <li><a href="#import_other_data.r" id="toc-import_other_data.r" class="nav-link" data-scroll-target="#import_other_data.r"><em>01_Import_other_data.R</em></a></li>
  </ul></li>
  <li><a href="#iii.-initial-data-processing-03_merging_and_geographic_delineation" id="toc-iii.-initial-data-processing-03_merging_and_geographic_delineation" class="nav-link" data-scroll-target="#iii.-initial-data-processing-03_merging_and_geographic_delineation"><span class="text-background-green bold">III. Initial data processing</span>: <code>/03_Merging_and_geographic_delineation/</code></a>
  <ul>
  <li><a href="#merge_datasets.r" id="toc-merge_datasets.r" class="nav-link" data-scroll-target="#merge_datasets.r"><em>01_Merge_datasets.R</em></a>
  <ul class="collapse">
  <li><a href="#detection-of-duplicates" id="toc-detection-of-duplicates" class="nav-link" data-scroll-target="#detection-of-duplicates"><strong>Detection of duplicates</strong></a></li>
  <li><a href="#additional-data-preparation" id="toc-additional-data-preparation" class="nav-link" data-scroll-target="#additional-data-preparation"><strong>Additional data preparation</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#iv.-chronologies-04_chronologies" id="toc-iv.-chronologies-04_chronologies" class="nav-link" data-scroll-target="#iv.-chronologies-04_chronologies"><span class="text-background-purple bold">IV. Chronologies</span>: <code>/04_Chronologies/</code></a>
  <ul>
  <li><a href="#note-on-age-depth-modelling" id="toc-note-on-age-depth-modelling" class="nav-link" data-scroll-target="#note-on-age-depth-modelling">Note on age-depth modelling</a></li>
  <li><a href="#prepare_chron_control_tables.r" id="toc-prepare_chron_control_tables.r" class="nav-link" data-scroll-target="#prepare_chron_control_tables.r"><em>01_Prepare_chron_control_tables.R</em></a>
  <ul class="collapse">
  <li><a href="#calibration-curves" id="toc-calibration-curves" class="nav-link" data-scroll-target="#calibration-curves"><strong>Calibration curves</strong></a></li>
  <li><a href="#types-of-chronology-control-points" id="toc-types-of-chronology-control-points" class="nav-link" data-scroll-target="#types-of-chronology-control-points"><strong>Types of chronology control points</strong></a></li>
  <li><a href="#chronology-table-preparation" id="toc-chronology-table-preparation" class="nav-link" data-scroll-target="#chronology-table-preparation"><strong>Chronology table preparation</strong></a></li>
  <li><a href="#percentage-carbon" id="toc-percentage-carbon" class="nav-link" data-scroll-target="#percentage-carbon"><strong>Percentage carbon</strong></a></li>
  </ul></li>
  <li><a href="#run_age_depth_models.r" id="toc-run_age_depth_models.r" class="nav-link" data-scroll-target="#run_age_depth_models.r"><em>02_Run_age_depth_models.R</em></a>
  <ul class="collapse">
  <li><a href="#multi-core-computation" id="toc-multi-core-computation" class="nav-link" data-scroll-target="#multi-core-computation"><strong>Multi-core computation</strong></a></li>
  <li><a href="#iterations" id="toc-iterations" class="nav-link" data-scroll-target="#iterations"><strong>Iterations</strong></a></li>
  </ul></li>
  <li><a href="#predict_ages.r" id="toc-predict_ages.r" class="nav-link" data-scroll-target="#predict_ages.r"><em>03_Predict_ages.R</em></a></li>
  <li><a href="#save_ad_figures.r" id="toc-save_ad_figures.r" class="nav-link" data-scroll-target="#save_ad_figures.r"><em>04_Save_AD_figures.R</em></a></li>
  <li><a href="#merge_chron_output.r" id="toc-merge_chron_output.r" class="nav-link" data-scroll-target="#merge_chron_output.r"><em>05_Merge_chron_output.R</em></a></li>
  </ul></li>
  <li><a href="#v.-harmonisation-05_harmonisation" id="toc-v.-harmonisation-05_harmonisation" class="nav-link" data-scroll-target="#v.-harmonisation-05_harmonisation"><span class="text-background-pink bold">V. Harmonisation</span>: <code>/05_Harmonisation/</code></a>
  <ul>
  <li><a href="#note-on-harmonisation" id="toc-note-on-harmonisation" class="nav-link" data-scroll-target="#note-on-harmonisation">Note on harmonisation</a></li>
  <li><a href="#harmonisation.r" id="toc-harmonisation.r" class="nav-link" data-scroll-target="#harmonisation.r"><em>01_Harmonisation.R</em></a></li>
  </ul></li>
  <li><a href="#vi.-data-filtering-06_main_filtering" id="toc-vi.-data-filtering-06_main_filtering" class="nav-link" data-scroll-target="#vi.-data-filtering-06_main_filtering"><span class="text-background-coral bold">VI. Data filtering</span>: <code>/06_Main_filtering/</code></a>
  <ul>
  <li><a href="#note-on-data-filtering" id="toc-note-on-data-filtering" class="nav-link" data-scroll-target="#note-on-data-filtering">Note on data filtering</a></li>
  <li><a href="#level_filtering.r" id="toc-level_filtering.r" class="nav-link" data-scroll-target="#level_filtering.r"><em>01_Level_filtering.R</em></a>
  <ul class="collapse">
  <li><a href="#pollen-count-sum" id="toc-pollen-count-sum" class="nav-link" data-scroll-target="#pollen-count-sum">Pollen count sum</a></li>
  <li><a href="#age-criteria" id="toc-age-criteria" class="nav-link" data-scroll-target="#age-criteria">Age criteria</a></li>
  <li><a href="#level-age-extrapolation" id="toc-level-age-extrapolation" class="nav-link" data-scroll-target="#level-age-extrapolation">Level age extrapolation</a></li>
  <li><a href="#interest-period" id="toc-interest-period" class="nav-link" data-scroll-target="#interest-period">Interest period</a></li>
  <li><a href="#number-of-levels" id="toc-number-of-levels" class="nav-link" data-scroll-target="#number-of-levels">Number of levels</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#vii.-outputs-07_outputs" id="toc-vii.-outputs-07_outputs" class="nav-link" data-scroll-target="#vii.-outputs-07_outputs"><span class="text-background-orange bold">VII. Outputs</span>: <code>/07_Outputs/</code></a>
  <ul>
  <li><a href="#pollen_diagrams.r" id="toc-pollen_diagrams.r" class="nav-link" data-scroll-target="#pollen_diagrams.r"><em>01_Pollen_diagrams.R</em></a></li>
  <li><a href="#save_assembly.r" id="toc-save_assembly.r" class="nav-link" data-scroll-target="#save_assembly.r"><em>02_Save_assembly.R</em></a></li>
  <li><a href="#save_references.r" id="toc-save_references.r" class="nav-link" data-scroll-target="#save_references.r"><em>03_Save_references.R</em></a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 22, 2022</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">March 12, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="a-step-by-step-guide-to-data-processing-with-fossilpol" class="level1">
<h1>A step-by-step guide to data processing with FOSSILPOL</h1>
<div class="columns">
<div class="column" style="width:75%;">
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>The FOSSILPOL Workflow is structured in a modular manner, where all steps are organised sequentially and guided by one main configuration file (<em>Config file</em>) where all criteria and setup configurations are pre-defined by the user.</p>
</section>
</div><div class="column" style="width:5%;">

</div><div class="column" style="width:20%;">
<p><br></p>
<hr>
<p><br></p>
<p><img src=".\figures/Logo FOSSILPOL regular - 600ppi.png" class="img-fluid"></p>
</div>
</div>
<section id="figure-1figure-1" class="level3">
<h3 class="anchored" data-anchor-id="figure-1figure-1">Figure 1<img src="figures/Workflow complete - 600ppi.png" class="img-fluid" alt="Figure 1"></h3>
</section>
<section id="data-input" class="level2">
<h2 class="anchored" data-anchor-id="data-input">Data input</h2>
<p>The FOSSILPOL workflow is set up in a way that data from <a href="https://www.neotomadb.org/">Neotoma Paleoecological Database</a> (“<em>Neotoma</em>” hereafter) are the primary data input. However, other data sources can also be used in parallel by using our predefined format (<a href="#figure-2figure-2">Fig. 2</a>). The user thus has the flexibility to source data from either Neotoma or from another data source as long as our predefined format file is used (see <a href="#ii.-data-sourcing-02_other_source">other data sourcing</a>).</p>
<p>Three additional data inputs are required for the initial set-up of the Workflow:</p>
<ol type="1">
<li><p><strong>Configuration file</strong> (<code>00_Config_file.R</code>) - this contains all the user-selected settings which will be applied throughout the Workflow. These range from technical settings (e.g.&nbsp;location of the data storage) to specific requirements (e.g.&nbsp;filtering criteria) for records to be included. An overview of where the config critera are used through the Workflow is summaried in (<a href="#figure-2figure-2">Fig. 2</a>).</p></li>
<li><p><strong>Geographical shapefiles</strong> - the workflow is internally set-up in a way that data are processed by geographical regions and shapefiles are used to assign relevant geographical information to the records to process. First, the Workflow is conceptualised for a global project, so the general structure of data processing is done <em>per continent</em> (i.e.&nbsp;<code>region</code> = “<em>continent</em>”), but the user can use any other delineation of interest. The Workflow comes with a default shapefile roughly delimiting continents, but it can be adjusted or replaced as per project needs. Second, the taxonomic harmonisation of records is structured by <em>harmonisation regions</em> provided by <code>harmonisation region shapefile</code>. By default, this shapefile is a copy of the continental shapefile, but as harmonisation tables are region-specific (see next data input item) this shapefile needs to be adjusted to represent the geographical delimitation of the harmonisation regions used. Finally, if the user is interested in other biogeographic, climatic, or ecological units of interest to be linked to each record (e.g.&nbsp;ecozones, biome type, climate zones), then additional shapefiles (or TIF files) can be added to the workflow (see <a href="#additional-data-preparation">details here</a>).</p></li>
<li><p><strong>Harmonisation tables</strong> - in each project, one harmonisation table must be provided per harmonisation region (delimited by the corresponding harmonisation region shapefile, see above). A harmonisation table always comes with two columns: i) <code>original taxa</code>(original taxa) with taxonomic names originally present in Neotoma and/or other data source in the project, and ii) <code>level_1</code> (harmonised taxa) with the standardised taxonomic names. The Workflow will detect if a harmonisation table has been provided by the user, or otherwise create a new table with all detected <em>raw</em> taxa names for each harmonisation region. The latter can consequently serve as a template for harmonisation in the <code>level_1</code> column (see <a href="#v.-harmonisation-05_harmonisation">details here</a>).</p></li>
</ol>
<section id="figure-2figure-2" class="level3">
<h3 class="anchored" data-anchor-id="figure-2figure-2">Figure 2<img src="figures/Workflow_Detailed.png" class="img-fluid" alt="Figure 2"></h3>
</section>
</section>
<section id="data-storage" class="level2">
<h2 class="anchored" data-anchor-id="data-storage">Data storage</h2>
<p>The Workflow will produce several files including <em>temporary output files</em>, <em>stop-check</em> tables, and final <em>outputs</em> (data assembly, figures, etc.):</p>
<ol type="1">
<li><p><strong>Temporary output files</strong>: the Workflow is set up in a way that temporary (in-progress) data files are saved at various stages of the Workflow. Each file will contain the date of creation for easier organisation. When run multiple times, the Workflow will automatically detect if there are any changes in a selected file and only overwrite it, if an updated file is produced (this is powered by {<a href="https://github.com/HOPE-UIB-BIO/R-Utilpol-package">RUtilpol</a>} package). This also means that the user does not have to re-run the whole Workflow but can re-run only specific parts. As the total size of the files can become substantial, the user can specify if all files should be stored within the project folder (default) or in another directory (specified by using the <code>data_storage_path</code> in the Config file). With such specification, and after running the <code>00_Config_file.R</code> script, there will be an additional folder structure created (see <a href="#code-block-3">Code block 3</a>).</p></li>
<li><p><strong><em>stop-checks</em> CSV tables</strong>: while running the Workflow, there will be several times that a user will be asked to check and, where necessary, adjust the produced CSV tables to subsequently continue with the Workflow (i.e.&nbsp;re-run script). This is done to oblige the user to check the produced intermediate results before continuing. For example, at a certain point, the Workflow will produce a list of all ecological groups detected within the dataset compilation obtained from Neotoma. A user then has to edit the mentioned CSV table and specify, which ecological groups should be kept (<code>include</code> = <code>TRUE</code>) and which should be filtered out (<code>include</code> = <code>FALSE</code>). Note that there are several stop-checks throughout the Workflow (see overview in <a href="#figure-2figure-2">Fig. 2</a>).</p></li>
<li><p><strong>Workflow output</strong> (<code>Outputs/</code>, see <a href="#vii.-outputs-07_outputs">Section VII</a> for more information):</p>
<ul>
<li>a ready-to-use, taxonomically harmonised and temporally standardised compilation of fossil pollen data, ready for the analytical stage (rds format)</li>
<li>plots of modelled age-depth curves for each record (pdf format)</li>
<li>pollen diagram of each record (pdf format)</li>
<li>metadata table relaying the main data contributor, contact information, and corresponding publications for citation purposes of the used datasets (PDF).</li>
<li>reproducibility bundle, a zip file with contains all important sections for a reproducibility of the whole project.<br>
</li>
<li>overview figures of the spatial and temporal distribution of the dataset compilation, namely a map and a graph of the record lengths, respectively (PDF).</li>
</ul></li>
</ol>
<section id="code-block-3" class="level3">
<h3 class="anchored" data-anchor-id="code-block-3">Code block 3</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>│</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>└───Data</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>│   │</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>│   └───Input</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>│   │   └───Chronology_setting</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>│   │   │   │</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>│   │   │   └───Bchron_crash</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>│   │   │   │</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>│   │   │   └───Chron_control_point_types</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>│   │   │   │</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>│   │   │   └───Percentage_radiocarbon</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>│   │   └───Depositional_environment</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>│   │   │   │</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>│   │   │   └───Neotoma</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>│   │   │   │</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>│   │   │   └───Other</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>│   │   └───Eco_group</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>│   │   └───Harmonisation_tables</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>│   │   └───Neotoma_download</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>│   │   └───Potential_duplicates</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>│   │   └───Other</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>│   │   │</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>│   │   └───Regional_age_limits</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>│   │   </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>│   └───Personal_database_storage</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>│   │</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>│   └───Processed</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>│       └───Chronology</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>│       │   └───Chron_tables_prepared</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>│       │   └───Models_full</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>│       │   └───Predicted_ages</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>│       │   └───Temporary_output</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>│       └───Data_filtered</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>│       └───Data_harmonised</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>│       └───Data_merged</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>│       └───Data_with_chronologies</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>│       └───Neotoma_processed</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>│       │   └───Neotoma_chron_control</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>│       │   └───Neotoma_dep_env</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>│       │   │</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>│       │   └───Neotoma_meta</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>│       │</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>│       └───Other</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>│ </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>└───Outputs</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    │</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    └───Data</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    │</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    └───Figures</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    │   │</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    │   └───Chronology</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    │   │</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    │   └───Pollen_diagrams</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    │   </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    └───Tables</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        │</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        └───Meta_and_references</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-processing" class="level2">
<h2 class="anchored" data-anchor-id="data-processing">Data processing</h2>
<p>Here we focus on the scripts within the <code>R/01_Data_processing</code> folder representing all steps needed for data processing (from obtaining data to the final dataset compilation), organised in the following Sections:</p>
<ol type="I">
<li><p><strong><a href="#i.-data-sourcing-01_neotoma_source">Data sourcing: <code>/01_Neotoma_source/</code></a></strong> - retrieve and process data from Neotoma</p></li>
<li><p><strong><a href="#ii.-data-sourcing-02_other_source">Data sourcing: <code>/02_Other_source/</code></a></strong> - process data from other data source (optional)</p></li>
<li><p><strong><a href="#iii.-initial-data-processing-03_merging_and_geographic_delineation">Initial data processing: <code>/03_Merging_and_geographic_delineation/</code></a></strong> - merge data sources, filter out duplicates, and assign values based on geographical location</p></li>
<li><p><strong><a href="#iv.-chronologies-04_chronologies">Chronologies: <code>/04_Chronologies/</code></a></strong> - prepare chronology control tables, calculate age-depth models, and predict ages for levels</p></li>
<li><p><strong><a href="#v.-harmonisation-05_harmonisation">Harmonisation: <code>/05_Harmonisation/</code></a></strong> - prepare all harmonisation tables and harmonise pollen taxa (morphotypes)</p></li>
<li><p><strong><a href="#vi.-data-filtering-06_main_filtering">Data filtering: <code>/06_Main_filtering/</code></a></strong> - filter out levels and records based on user-defined criteria</p></li>
<li><p><strong><a href="#vii.-outputs-07_outputs">Outputs: <code>/07_Outputs/</code></a></strong> - save the final output including dataset compilation, pollen diagrams, metadata information, graphical summary snd reproducibility bundle</p></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
<section id="i.-data-sourcing-01_neotoma_source" class="level3">
<h3 class="anchored" data-anchor-id="i.-data-sourcing-01_neotoma_source"><span class="text-background-blue bold">I. Data sourcing</span>: <code>/01_Neotoma_source/</code></h3>
<ul>
<li><p><code>Run_01_01.R</code>- run all scripts within this folder</p></li>
<li><p><a href="#download_neotoma.r"><code>01_Download_neotoma.R</code></a>- download the pollen data from the Neotoma database</p></li>
<li><p><a href="#extract_samples.r"><code>02_Extract_samples.R</code></a> - create a table from Neotoma’s downloaded lists and download author information</p></li>
<li><p><a href="#filter_dep_env.r"><code>03_Filter_dep_env.R</code></a> - get depositional environment data and filter out records based on the user preferences</p></li>
<li><p><a href="#extract_chron_control_tables.r"><code>04_Extract_chron_control_tables.R</code></a> - get chronologies, including the preferred table with chronology control points</p></li>
<li><p><a href="#extract_raw_pollen_data.r"><code>05_Extract_raw_pollen_data.R</code></a> - extract the raw pollen counts from Neotoma and filter by user-selected ecological groups.</p></li>
</ul>
<section id="download_neotoma.r" class="level4">
<h4 class="anchored" data-anchor-id="download_neotoma.r"><em>01_Download_neotoma.R</em></h4>
<p>All pollen records are downloaded from Neotoma based on the geographical criteria (spatial extent, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>1</strong>) and the selected data type, in this case: <code>"pollen"</code>. Note that a more complex spatial extent, like a polygon, can be used with the <code>loc</code> argument in <code>RFossilpol::proc_neo_get_all_neotoma_datasets()</code>(see usage of <code>loc</code> in <code>neotoma2</code> example <a href="https://github.com/NeotomaDB/EPD_binder/blob/main/slides/slides2.pdf">here</a>).</p>
</section>
<section id="extract_samples.r" class="level4">
<h4 class="anchored" data-anchor-id="extract_samples.r"><em>02_Extract_samples.R</em></h4>
<p>Each record is processed using a unique dataset ID (<code>dataset_id</code>) with metadata information extracted. Metadata includes information about the name of the record, geographical information, and the authors and publication DOI connected to the dataset. The authors and their link to the dataset are saved into a separate Author-Dataset database created specifically for each project. It allows easy extraction of authors and DOI for the final dataset compilation produced by the Workflow.</p>
</section>
<section id="filter_dep_env.r" class="level4">
<h4 class="anchored" data-anchor-id="filter_dep_env.r"><em>03_Filter_dep_env.R</em></h4>
<p>Depositional information from each record gives information about the environments where a record was extracted. Based on the research question, there could be a preference for certain environments (e.g.&nbsp;terrestrial vs.&nbsp;marine). Currently in Neotoma, the data about depositional environments are organised in a hierarchical structure (e.g.&nbsp;“<em>Pond</em>” is nested in “<em>Natural Lake</em>”, which is nested in “<em>Lacustrine</em>”), in which the maximum number of nested layers is five. At the lowest hierarchical level, there are currently over 50 different categories of depositional environments (for fossil pollen records). Based on the selected records, the Workflow will produce a list of all depositional environments (and their hierarchical position) present in the user´s data selection. The user is then requested to define the environments of choice (this is a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>). Note that excluding depositional environments with the higher hierarchical position will <strong>not</strong> automatically exclude all depositional environments nested in it.</p>
</section>
<section id="extract_chron_control_tables.r" class="level4">
<h4 class="anchored" data-anchor-id="extract_chron_control_tables.r"><em>04_Extract_chron_control_tables.R</em></h4>
<p>Chronology data for each record is available in a table that contains information about chronology control points used to construct an age-depth model. Some records can have multiple chronology tables as some records have been used for several projects or recalibrated (updated) by data stewards. These tables are numbered according to the order in which they were created and uploaded. Each chronology comes with the age-unit of the age-depth model output (e.g.&nbsp;“<em>Radiocarbon years BP</em>”, “<em>Calibrated radiocarbon years BP</em>”) and the temporal range of the record (youngest and oldest age). The chronologies in “<em>Radiocarbon years BP</em>” are often older chronologies as it is now common practice to recalibrate radiocarbon-dated material and produce chronologies expressed in “<em>Calibrated radiocarbon years BP</em>”. Note: The chronologies in “<em>Calibrated radiocarbon years BP</em>” still come with chronology table(s) containing the uncalibrated radiocarbon ages and need to be calibrated by the user if a new age-depth model is desired. The Workflow automatically selects one table per record based on the order defined by <code>chron_order</code> in the Config file (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>2</strong>). Note: if more tables have the same age-unit type (e.g.&nbsp;Calibrated radiocarbon years BP), the Workflow will opt for the more recent table. The user can specify their preference for certain age-unit types in the Config file. In addition, only records which have at least a certain number of control points (defined by <code>min_n_of_control_points</code> in the Config file, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>3</strong>) will be subsequently used.</p>
</section>
<section id="extract_raw_pollen_data.r" class="level4">
<h4 class="anchored" data-anchor-id="extract_raw_pollen_data.r"><em>05_Extract_raw_pollen_data.R</em></h4>
<p>Each level of each record comes with additional information: a) unique sample ID (sample_id), b) information about depth (and estimated age later), and c) pollen counts for each taxon present in that level. The information about levels is split into two different tables (first with depth and ages, and second with pollen counts) linked together by sample ID (<code>sample_id</code>).</p>
<p>The Workflow will only keep records with a minimal number of levels as defined in the Config file (<code>min_n_levels</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>4</strong>). The minimum number of levels is by default selected as three but the user can change this setting.</p>
<p>In the case of data sourced from Neotoma, each pollen taxon has information about the ecological group (e.g.&nbsp;palms, mangroves, etc). Based on the selected records, the Workflow will produce a full list of all ecological groups after which the user is requested to define which ecological groups to include (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>, see explanation of abbreviation in <a href="#table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma">Table 1</a>)</p>
<section id="table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma" class="level5">
<h5 class="anchored" data-anchor-id="table-1.-ecological-groups-assigned-to-pollen-taxa-as-defined-in-neotoma"><strong>Table 1. Ecological groups assigned to pollen taxa as defined in Neotoma</strong></h5>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>ABBREVIATION</th>
<th>ECOLOGICAL GROUP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ACRI</td>
<td>Acritarchs</td>
</tr>
<tr class="even">
<td>ANAC</td>
<td>Anachronic</td>
</tr>
<tr class="odd">
<td>ALGA</td>
<td>Algae (e.g.&nbsp;Botryococcus)</td>
</tr>
<tr class="even">
<td>AQB</td>
<td>Aquatics (e.g.&nbsp;Sphagnum)</td>
</tr>
<tr class="odd">
<td>AQVP</td>
<td>Aquatic vascular plants (e.g.&nbsp;Isoetes)</td>
</tr>
<tr class="even">
<td>BIOM</td>
<td>Biometric measurements</td>
</tr>
<tr class="odd">
<td>EMBR</td>
<td>Embryophyta</td>
</tr>
<tr class="even">
<td>FUNG</td>
<td>Fungi</td>
</tr>
<tr class="odd">
<td>LABO</td>
<td>Lab analyses</td>
</tr>
<tr class="even">
<td>MAN</td>
<td>Mangroves</td>
</tr>
<tr class="odd">
<td>PALM</td>
<td>Palms</td>
</tr>
<tr class="even">
<td>PLNT</td>
<td>Plant</td>
</tr>
<tr class="odd">
<td>SEED</td>
<td>Unidentified, but definitely pollen - Spermatophyte rank or clade</td>
</tr>
<tr class="even">
<td>SUCC</td>
<td>Succulents</td>
</tr>
<tr class="odd">
<td>TRSH</td>
<td>Trees and shrubs</td>
</tr>
<tr class="even">
<td>UNID</td>
<td>Unknown and Indeterminable</td>
</tr>
<tr class="odd">
<td>UPBR</td>
<td>Upland bryophytes</td>
</tr>
<tr class="even">
<td>UPHE</td>
<td>Upland herbs</td>
</tr>
<tr class="odd">
<td>VACR</td>
<td>Terrestrial vascular cryptogams</td>
</tr>
<tr class="even">
<td>VASC</td>
<td>Vascular plants</td>
</tr>
</tbody>
</table>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
</section>
<section id="ii.-data-sourcing-02_other_source" class="level3">
<h3 class="anchored" data-anchor-id="ii.-data-sourcing-02_other_source"><span class="text-background-blue bold">II. Data sourcing</span>: <code>/02_Other_source/</code></h3>
<ul>
<li><code>Run_01_02.R</code> - run all scripts within this folder</li>
<li><a href="#import_other_data.r"><code>01_Import_other_data.R</code></a> - source other data sources and filter the records in a similar way as Neotoma.</li>
</ul>
<section id="note-on-other-data-sourcing" class="level4">
<h4 class="anchored" data-anchor-id="note-on-other-data-sourcing">Note on other data sourcing</h4>
<p>Our FOSSILPOL Workflow allows the use of other data source in combination with the Neotoma data. Including other data sources is fully optional and can be skipped as indicated by <code>use_other_datasource</code> = <code>TRUE</code>/<code>FALSE</code> in the Config file.</p>
<p>Any data can be used as long as it contains the following required information: a) metadata, b) depositional environment, c) chronology, d) level (age-depth), and e) pollen counts. In order to prepare data for usage, the user needs to download <a href="https://figshare.com/articles/dataset/FOSSILPOL-private_data-template/19794112">file template</a> specially prepared for this. Each pollen record needs to be stored as a separate file with <strong>unique</strong> name. We recommend e.g., <code>private_data_(insert_site_name).xlsx</code>. The <em>site name</em> in the filename is crucial as it will be compared against all other pollen records in Neotoma to test for potential duplicates in a later stage of the Workflow. All files must be stored in <code>/Data/Input/Other/</code> (or specified by <code>dir_files</code> argument, see below).</p>
</section>
<section id="import_other_data.r" class="level4">
<h4 class="anchored" data-anchor-id="import_other_data.r"><em>01_Import_other_data.R</em></h4>
<p>The sourcing of other data sources follows a simple order of actions:</p>
<ol type="1">
<li><p>Data files need to be prepared by the user following the template one record per file.</p></li>
<li><p>Data are extracted and formatted to be compatible with Neotoma data using the <code>RFossilpol::import_datasets_from_folder()</code> function, with the following arguments:</p>
<ul>
<li><code>dir_files</code> - user can specify which folder contains the prepared data (default = <code>Data/Input/Other/</code></li>
<li><code>suffix</code> - argument to keep track of the source of the data. Default is set to <code>"other"</code>, which means that datasets can be easily identified as their name will be <code>(dataset id)_other</code></li>
<li><code>source_of_data</code> - will flag the source of each dataset in the compilation in meta-data overview (see <a href="#vii.-outputs-07_outputs">section VII</a>). Default is set to <code>"personal_data"</code></li>
<li><code>data_publicity</code> - will flag the data publicity of each dataset in the compilation in meta-data overview (see <a href="#vii.-outputs-07_outputs">section VII - Outputs</a>). Default is set to <code>"restricted"</code></li>
<li><code>pollen_percentage</code> - pollen counts measured as proportions (e.g., from scanning of pollen diagrams) can be flagged here. Default set to <code>FALSE</code></li>
</ul></li>
<li><p>Names of data contributors are extracted and added to the <a href="#extract_samples.r">Author-Dataset database</a> used in Author-dataset attribution (see <a href="#vii.-outputs-07_outputs">section VII - Outputs</a>).</p></li>
<li><p>Data are treated in a similar way as data from Neotoma, in terms of filtering by geographical location, number of levels (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>5</strong>,<strong>6</strong>), and depositional environments (<a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>).</p></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
<section id="iii.-initial-data-processing-03_merging_and_geographic_delineation" class="level3">
<h3 class="anchored" data-anchor-id="iii.-initial-data-processing-03_merging_and_geographic_delineation"><span class="text-background-green bold">III. Initial data processing</span>: <code>/03_Merging_and_geographic_delineation/</code></h3>
<ul>
<li><code>Run_01_03.R</code> - run all scripts within this folder</li>
<li><a href="#merge_datasets.r"><code>01_Merge_datasets.R</code></a> - merge data from all sources, filter out duplicates, and assign values based on geographical location</li>
</ul>
<section id="merge_datasets.r" class="level4">
<h4 class="anchored" data-anchor-id="merge_datasets.r"><em>01_Merge_datasets.R</em></h4>
<p>After initial data processing, records from Neotoma and Other sources are merged together.</p>
<section id="detection-of-duplicates" class="level5">
<h5 class="anchored" data-anchor-id="detection-of-duplicates"><strong>Detection of duplicates</strong></h5>
<p>There is a possibility that some datasets from the other data sources are already in Neotoma. To avoid duplication within the final dataset compilation, the Workflow will compare datasets from both sources and identify potential duplicates. This step is optional but recommended to follow. To do so, the user needs to specify that <code>detect_duplicates</code> == <code>TRUE</code> in the Config file (this is set as default, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>7</strong>). The Workflow will start a simple subroutine using the function <code>RFossilpol::proc_filter_out_duplicates()</code>. Because comparing all records within each data source to each other is relatively computationally demanding, the function will split the data into several groups using their geographical location (ca. 100 records per group). The user can define the number of groups using the <code>n_subgroups</code> argument. Next, each record from one source is compared to all records from the other source as long as they are within 1 degree radius (the assumption here is that duplicated records will be in a similar location). The user can define the maximum distance using the <code>max_degree_distance</code> argument. Finally, the Workflow will output a list of potential duplicated records (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>). For each record-pair, the user must specify, which records should be deleted by writing <code>1</code> (deleting the Neotoma) or <code>2</code> (deleting the other data source) in the <code>delete</code> column of the created list (leaving <code>0</code> will leave both records in).</p>
</section>
<section id="additional-data-preparation" class="level5">
<h5 class="anchored" data-anchor-id="additional-data-preparation"><strong>Additional data preparation</strong></h5>
<p>Several more steps take place to create the fully merged dataset compilation before proceeding to the chronology step (does not require any action by user):</p>
<ol type="1">
<li><p>All taxon names are transformed into a more computer-friendly format for easier manipulation. The <code>RFossilpol::proc_clean_count_names()</code> function will first transform special characters to text (e.g.&nbsp;<code>+</code> to <code>_plus_</code>) and then use the {<a href="https://sfirke.github.io/janitor/">janitor</a>} to transform into <a href="https://en.wikipedia.org/wiki/Snake_case">“<em>snake_case</em>” style</a>. In addition, the user can specify additional specific changes in names (e.g.&nbsp;based on presence of special characters) by adjusting the <code>user_name_patterns</code> argument (see example in the script). During this cleaning of taxa names, the Workflow will save <code>taxa_refrence_table</code> for back traceability to Neotoma taxonomy. The <code>taxa_reference_table</code> is a CSV file saved in the same folder as the harmonisation tables (<code>Data/Input/Harmonisation_tables/</code>). More about <a href="#v.-harmonisation-05_harmonisation">harmonisation process</a>.</p></li>
<li><p>Individual levels (sample depths) are sorted by their depth for each record by <code>RFossilpol::proc_prepare_raw_count_levels()</code>. This includes subroutines, for example, only keeping levels present in all data tables, filtering out levels without pollen data, and taxa which are not present in any level.</p></li>
<li><p>Spatial information for each record is assigned based on the provided geographical shapefiles. Specifically:</p>
<ul>
<li><p><strong>Region information</strong> - the shapefile in <code>Data/Input/Spatial/Regions_shapefile</code> will assign the regional names for each record (see <a href="#data-input">Data input Section</a>). The user can (and is recommended to) change the spatial delineation of the data by altering or replacing the shapefile.</p></li>
<li><p><strong>Political delineation (countries)</strong> - obtained from <a href="www.gadm.org">GADM database</a>, version 2.8, November 2015.</p></li>
<li><p><strong>Harmonisation region</strong> - the shapefile in <code>Data/Input/Spatial/Harmonisation_regions_shapefile</code> will assign the harmonisation region (to be able to link the corresponding harmonisation table to use; See see <a href="#data-input">Data input Section</a>). The default shapefile in the Workflow is a copy of the Region information shapefile but should be adjusted by the user to correspond to the area covered by the different harmonisation tables.</p></li>
<li><p><strong>Calibration curves (normal and post-bomb)</strong> - depending on the geographical position of the record, a different calibration curve needs to be assigned, as different curves are used for the northern and southern hemispheres, and for terrestrial and marine environments. See more details about <a href="#calibration-curves">calibration curves</a>.</p></li>
<li><p><strong>Additional</strong> - The user can add any additional spatial delimitation (e.g.&nbsp;ecozones). This will require adding the specific shapefile (or TIF file) in <code>/Data/Input/Spatial/NAME_OF_FOLDER</code> and adjusting the R code manually (<code>optional_info_to_assign</code>) so that the shapefile is sourced, and its information assigned to each record (see the example in the script).</p></li>
</ul></li>
<li><p>The Workflow will create a new table with age limitations for each region presented in the data, which needs to be edited by the user (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>). For example, <code>Regional_age_limits</code> table will have the following values:</p>
<ul>
<li><code>young_age</code> = youngest age the record must have</li>
<li><code>old_age</code> = oldest age the record must have</li>
<li><code>end_of_interest_period</code> = levels beyond this age will be omitted</li>
</ul></li>
</ol>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
</section>
<section id="iv.-chronologies-04_chronologies" class="level3">
<h3 class="anchored" data-anchor-id="iv.-chronologies-04_chronologies"><span class="text-background-purple bold">IV. Chronologies</span>: <code>/04_Chronologies/</code></h3>
<ul>
<li><code>Run_01_04.R</code> - run all scripts within this folder</li>
<li><a href="#prepare_chron_control_tables.r"><code>01_Prepare_chron_control_tables.R</code></a> - prepare the chronology tables for age-depth modelling</li>
<li><a href="#run_age_depth_models.r"><code>02_Run_age_depth_models.R</code></a>- create age-depth models with BChron</li>
<li><a href="#predict_ages.r"><code>03_Predict_ages.R</code></a> - estimate the ages of individual levels</li>
<li><a href="#save_ad_figures.r"><code>04_Save_AD_figures.R</code></a> - save visual output of the age-depth models in pdf format</li>
<li><a href="#merge_chron_output.r"><code>05_Merge_chron_output.R</code></a> - link age-depth models to corresponding datasets</li>
</ul>
<section id="note-on-age-depth-modelling" class="level4">
<h4 class="anchored" data-anchor-id="note-on-age-depth-modelling">Note on age-depth modelling</h4>
<p>To estimate the age of individual levels based on their depth, an age-depth model needs to be constructed based on the chronology data of the record. An age-depth model will provide age estimates of each individual level and the full age range of the record.</p>
<p>Age-depth modelling can be very computationally heavy and can take a substantial amount of time. Therefore, the Workflow automatically processes several files (rds format):</p>
<ul>
<li><em>Chronology-control-tables</em>:
<ul>
<li><code>/Data/Processed/Chronology/Chron_tables_prepared/chron_tables_prepared*.rds</code> contains all the chronology control tables prepared to be re-calibrated</li>
</ul></li>
<li><em>Age-depth-models</em>:
<ul>
<li><code>/Data/Processed/Chronology/Models_full/*</code> contains one file for each age-depth model</li>
</ul></li>
<li><em>Predicted-ages</em>:
<ul>
<li><code>/Data/Processed/Chronology/Predicted_ages/predicted_ages*.rds</code> contains the predicted ages using the age-depth models</li>
</ul></li>
</ul>
<p>It may be <strong>not</strong> preferential to re-run all age-depth models every time the user wants to re-run the Workflow. Therefore, the Workflow offers the option to save the successful age-depth models (<em>Age-depth-models</em> &amp; <em>Predicted-ages</em>) and keep them between individual runs. This can be done in several ways:</p>
<ul>
<li><p><code>recalib_AD_models</code> in the Config file can be set to <code>FALSE</code>. This will result in completely omitting the scripts aimed at calculating age-depth models, and therefore this step will be skipped. Note that this will only work if the age-depth models have already been successfully created at least once (<em>Predicted-ages</em> exists).</p></li>
<li><p><code>calc_AD_models_denovo</code> in the Config file can be set to <code>FALSE</code> (this is the default). When set to <code>TRUE</code>, the Workflow will <strong>not</strong> use the <em>Age-depth-models</em> files (successful age-depth models) and will re-calibrate everything “<em>de novo</em>”.</p></li>
<li><p><code>predict_ages_denovo</code> in the Config file is set to <code>FALSE</code> as the default. When set to <code>TRUE</code>, the Workflow will use all the age-depth model files but re-assign the ages to each level of all related records (even for records where ages were successfully predicted). This is done, for instance, when the number of levels in a record increased since the last Workflow run and these levels still need to have ages assigned.</p></li>
</ul>
<p><strong>IMPORTANT</strong>: If you select both <code>calc_AD_models_denovo</code> and <code>predict_ages_denovo</code> as <code>FALSE</code> for your first run of age-depth modelling, you might be asked by the Workflow to temporarily switch both to <code>TRUE</code> in the console (you do not have to change anything in the Config file).</p>
</section>
<section id="prepare_chron_control_tables.r" class="level4">
<h4 class="anchored" data-anchor-id="prepare_chron_control_tables.r"><em>01_Prepare_chron_control_tables.R</em></h4>
<p>Age-depth models are constructed using <em>chronology control points</em> (usually radiocarbon dates) with known depth, estimated age, and associated age uncertainties. Each record can and should ideally have several such points saved in the <em>chronology control table</em>. Each chronology control point has the following properties:</p>
<ul>
<li>Depth</li>
<li>Estimated age</li>
<li>Error of the estimated age</li>
<li>Type of the chronology control point</li>
<li>The calibration curve used (which is needed to convert the raw radiocarbon ages to calendar ages (Note: radiocarbon <em>ages</em> are not true calendar ages!)).</li>
</ul>
<p>This script will take several steps to prepare all records for age-depth modelling, specifically:</p>
<ol type="1">
<li>Create and attach the necessary calibration curves</li>
<li>Select the preferred chronology control point types</li>
<li>Prepare chronology tables (include fixing issues with percentage carbon (if necessary))</li>
</ol>
<section id="calibration-curves" class="level5">
<h5 class="anchored" data-anchor-id="calibration-curves"><strong>Calibration curves</strong></h5>
<p>Calibration curves are assigned to each control point based on several criteria. If a control point has a type flagged to be calibrated (see next section), a calibration curve is assigned based on the geographical position of the record. Note: only chronology control points of uncalibrated radiocarbon ages need recalibration. FOSSILPOL has a shapefile based on figure 7 in <a href="https://doi.org/10.1017/RDC.2020.59">Hogg et al (2020)</a> to correctly assigned IntCal20, SHCal20 and a mixed calibration curve to each record. We follow this recommendation “<em>…the use of (i) IntCal20 for areas north of the ITCZ in June-August (dashed lines in Figure 7) which receive NH air masses all year round, (ii) SHCal20 for areas south of ITCZ in December-February (dotted lines in Figure 7) which see SH air masses all year round, and (iii) a mixed curve for areas between the two seasonal ITCZ positions shown in Figure 7, which receive northern air masses in December-February and southern air masses in June-August.</em>” FOSSILPOL also comes with a mixed curve that was constructed using the {<a href="https://github.com/ahb108/rcarbon">rcarbon</a>} package with a proportion of curve contribution 1:1. See <a href="https://chrono.qub.ac.uk/blaauw/clam.html">more info</a> on mixed calibration curve use.</p>
<p>All calibration curves have an age limitation, i.e.&nbsp;each curve can be used only for certain ages. Radiocarbon calibration curves currently do not cover ages older than 55 thousand years. For the younger ages, during the last century, there are issues with the Earth’s atmospheric radiocarbon and a different set of calibration curves needs to be used. This is caused by the deployment of nuclear weapons in the ’50s and ’60s, which caused a spike in atmospheric radiocarbon and resulted in radiocarbon measurements from material in the following decades to return often highly negative ages. Therefore, if the control point has a radiocarbon age younger than 200 yr BP, a <em>post-bomb calibration curve</em> is used instead (see further below). As with the normal calibration curves, the geographical location of the record is taken into account to assign the corresponding post-bomb calibration curve.</p>
<p>Modern radiocarbon dates are calibrated by using one of the post-bomb calibration curves (<code>nh_zone_1</code>, <code>nh_zone_2</code>, <code>nh_zone_3</code>, <code>sh_zone_1_2</code>, <code>sh_zone_3</code>), following Hua et al., 2013 and <a href="http://calib.org/CALIBomb/">link</a>. The Workflow will automatically assign the corresponding curve based on the geographical location of the record (see function <code>IntCal::copyCalibrationCurve()</code>). If modern radiocarbon dates are detected, the Workflow will then display the detected records to the user and apply the conversion according to the post-bomb curves from the {<a href="https://cran.r-project.org/web/packages/IntCal/index.html">IntCal</a>} package.</p>
</section>
<section id="types-of-chronology-control-points" class="level5">
<h5 class="anchored" data-anchor-id="types-of-chronology-control-points"><strong>Types of chronology control points</strong></h5>
<p>Each control point in the control table has several properties: unique ID, depth, age, error, thickness, and chronology control point type (e.g.&nbsp;radiocarbon, biostratigraphic, annual laminations, tephra). Each type of chronology control point has different age uncertainties. For instance, many older records relied on indirect dating techniques based on biostratigraphic layers, similar geological levels from other records (e.g.&nbsp;a volcanic event), and pollen-based levels (e.g.&nbsp;the appearance of a key taxon), among others and can have large age uncertainties into thousands of years. Neotoma has over 50 different chronology controls points that fall within the categories of geochronological (e.g.&nbsp;lead-210, radiocarbon, uranium-series), relative time scale (e.g.&nbsp;MIS5e, Heinrich Stadial 1, Late Wisconsin event), stratigraphic (e.g.&nbsp;biostratigraphic events such as the introduction of anthropogenic taxa), cultural (e.g.&nbsp;European Settlement Horizon), other absolute dating methods (e.g.&nbsp;annual laminations, collection date), and other dating methods (e.g.&nbsp;extrapolated or guesses). Only the chronology control points in uncalibrated radiocarbon ages require recalibration with the calibration curves as most, if not all, other control points will be in calendar ages and no recalibration should be implemented.</p>
<p>A user has the option to select which control point types should be accepted “as-is” and which should be calibrated (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>). The Workflow will automatically produce a list of all detected control points from all selected records, which includes columns called <code>include</code> and <code>calibrate</code>. In the first, the user should indicate if the chronology control point should be included. In latter, the user should indicate if the point should be recalibrated using the calibration curves, here uncalibrated radiocarbon ages.</p>
</section>
<section id="chronology-table-preparation" class="level5">
<h5 class="anchored" data-anchor-id="chronology-table-preparation"><strong>Chronology table preparation</strong></h5>
<p>The chronology control tables will need to undergo a number of user-defined adjustments:</p>
<ul>
<li><p>filtering out unwanted control point types selected by user (defined by <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, see above)</p></li>
<li><p>filtering out records that do not fulfil the minimal number of control points (defined by <code>min_n_of_control_points</code> in the Config file, default = <code>2</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>8</strong>). The value <code>min_n_of_control_points</code> will serve as a criterion for the prepared chronology control tables, where records that do not fulfil such requirements will be filtered out. Note that there is a trade-off between accepting only the tables with a high number of control points per time interval (more robust age-depth model) and the number of records that will be able to fulfil strict criteria.</p></li>
<li><p>fixing instances of missing values. Defined in the Config file, the values <code>default_thickness</code> (defined in the Config file, default = <code>1</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>9</strong>) and <code>default_error</code> (default = <code>100</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>10</strong>) will replace missing values (<code>NA</code>) for thickness and error, specifically.</p></li>
<li><p>filtering out control points with an error that is considered too big. Any control point with an error bigger than <code>max_age_error</code> (defined in the Config file; default = <code>3000</code> yr, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>11</strong>) will be filtered out.</p></li>
<li><p>removing control points that are duplicated in terms of age and/or depth.</p></li>
<li><p>in several cases, the chronology control point from the core-top has a type specified as <code>guess</code>. A user can specify that the type <code>guess</code> is only acceptable to a certain depth using the <code>guess_depth</code> variable in the Config file (default is <code>10</code> cm, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>12</strong>)</p></li>
</ul>
<p>In addition, the number and distribution of such control points can give a good indicator of the temporal uncertainty around levels’ ages (<a href="https://doi.org/10.1007/s00334-012-0390-y">Giesecke et al.&nbsp;2014</a>, <a href="https://doi.org/10.5194/cp-12-387-2016">Flantua et al.&nbsp;2016</a>). For example, a record with few chronology control points within the focus time period will have large uncertainties of predicted ages. Hence, the information of the quality of chronologies, i.e.&nbsp;taking into account the types and levels of chronology control points, can be a criterion used in the selection of records.</p>
</section>
<section id="percentage-carbon" class="level5">
<h5 class="anchored" data-anchor-id="percentage-carbon"><strong>Percentage carbon</strong></h5>
<p>There are three ways by which post-bomb radiocarbon dates are reported, namely by 1) modern radiocarbon dates (&lt;0 F14C yr); 2) percent modern carbon (pMC, normalised to 100%); and 3) fraction radiocarbon (F14C, normalised to 1; <a href="https://doi.org/10.1017/S0033822200033154">Reimer et al.&nbsp;2004</a>). Currently, there is no direct way to know from Neotoma whether the dates are in pMC or F14C. Even if the cases are likely to be few, such dates need to be checked to avoid incorrect calculations.</p>
<p>The strongest rule of thumb is that normal radiocarbon dates and errors should always be integer (no decimals) and are uploaded so by the data stewards to Neotoma. The second rule of thumb is that pMC control points are characterised by an age value from around 100 with a decimal place. Thus, the Workflow will automatically export suspicious records and the user must specify which control points should be back-transformed (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, (<a href="#figure-2figure-2">Fig. 2</a>).). For those selected by the user to be back-transformed (<code>include</code> == <code>TRUE</code>), the Workflow will first convert the pMC values to <em>normal</em> post-bomb radiocarbon ages (negative 14C ages) by using the <code>IntCal::pMC.age()</code> function, after which normal post-bomb calibration curves are used to calibrate the values to final calendar ages (see above).</p>
<p>Although F14C has been recommended by experts for the reporting of post-bomb samples (<a href="https://doi.org/10.1017/S0033822200033154">Reimer et al.&nbsp;2004</a>, in practice, the bulk of the reporting is done as modern radiocarbon dates followed by pMC to a much lesser extent. The Workflow currently does not deal with F14C as no such cases have been detected to date. As this is not consistent with the rest of the data, back-transformation could be done when working with other data sources, and the {<a href="https://cran.r-project.org/web/packages/IntCal/index.html">IntCal</a>} package can be used to do so.</p>
</section>
</section>
<section id="run_age_depth_models.r" class="level4">
<h4 class="anchored" data-anchor-id="run_age_depth_models.r"><em>02_Run_age_depth_models.R</em></h4>
<p>Individual age-depth models are estimated using the {<a href="http://andrewcparnell.github.io/Bchron/">Bchron</a>} package, which estimates the Bayesian probabilistic trajectory of the age-depth model curve (non-parametric chronology model to age-depth data according to the Compound Poisson-Gamma model). Therefore, it is suitable for various combinations of control point types, outliers, and age reversals.</p>
<p>If there are many ages at close or similar depths (e.g.&nbsp;annual laminations), initialisation problems may occur and the Bchron could fail to converge the age-depth model. In such a scenario, the thickness of duplicated chronology control points is automatically increased by 0.01 (see <code>artificialThickness</code> argument in <code>Bchron::Bchronology()</code> function).</p>
<section id="multi-core-computation" class="level5">
<h5 class="anchored" data-anchor-id="multi-core-computation"><strong>Multi-core computation</strong></h5>
<p>Because creating age-depth models for multiple records can be computationally demanding, the Workflow uses multi-core (<em>parallel</em>) computation. The Workflow automatically detects the number of cores for the machine on which the code is running (this can be adjusted by specifying the number in <code>number_of_cores</code> in the Config file, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>14</strong>). Several age-depth models are then created at the same time. This is done by splitting the records into batches, with each batch containing a certain number of records (see <code>batch size</code> in Config file, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>13</strong>; by default it is based on the <code>number_of_cores</code>). If <code>number_of_cores</code> is selected (or detected) as <code>1</code>, the Workflow will not use the batch approach (as obsolete) and estimate the age-depth models one-by-one (see below).</p>
<p>Note that there is a possibility that the age-depth model estimation will crash (freeze) for unforeseen reasons. Therefore, the Workflow is structured in a way that if an estimation of the whole batch crashes, the Workflow will skip that batch and continue with other batches. The user can specify how long the machine should wait before skipping the batch with the <code>time_per_record</code> argument in the <code>RFossilpol::chron_recalibrate_ad_models()</code> function.</p>
<p>For each batch, the Workflow will try to estimate age-depth models three times. The user can specify the number of attempts by changing the <code>batch_attempts</code> in the <code>RFossilpol::chron_recalibrate_ad_models()</code> function. If the age-depth modelling is stopped in the process, the Workflow will automatically use the previously successful batches, which are saved automatically. This should help when the user needs to stop the age-depth modelling and resume it at a later time.</p>
<p>Next, the Workflow continues to another subroutine where age-depth models for records from <em>failed</em> batches are estimated one by one. Similar to batch estimation, the age-depth model estimation is tried three times for each <em>crashed</em> record until successful at least once. On some rare occasions, a record could cause R to freeze completely and prevents it from skipping to another record. In that case, the dataset ID of the dataset that caused the crash will be automatically written in the <em>Crash file</em> (found in <code>/Data/Input/Chronology_setting/Bchron_crash/</code>) and omitted from the future run of age-depth models. The user is recommended to do a detailed check of the specific dataset, e.g.&nbsp;the chronology control table for possible inconsistencies or other flaws that could be causing {<a href="http://andrewcparnell.github.io/Bchron/">Bchron</a>} to fail to produce an age-depth model.</p>
</section>
<section id="iterations" class="level5">
<h5 class="anchored" data-anchor-id="iterations"><strong>Iterations</strong></h5>
<p>In the Config file, the number of iterations is set to <code>50,000</code> by default, discarding the first <code>10,000</code> iterations (<em>burn-in</em>) and keeping every iteration beyond the burn-in with a step size of <code>40</code> (<em>thinning</em>) (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>15</strong>,<strong>16</strong>,<strong>17</strong>). The user can change the number of iterations by altering the <code>iteration_multiplier</code> in the Config file (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>18</strong>). This will result in changing the total interactions but keeping the ratios of burn-ins and thinning. Thus <code>1000</code> ((<code>50k</code> - <code>10k</code>) / <code>40</code>) posterior values are drawn. The default number of iterations should produce a robust estimation but they can be increased by the user if preferred (by increasing the <code>iteration_multiplier</code>). Note that increasing the <code>iteration_multiplier</code> will automatically increase the time that the program will wait for estimation of an age-depth model before skipping it (see <code>time_per_record</code> above).</p>
<p>The user should keep in mind that creating age-depth models for hundreds of records using a high number of iterations is computationally demanding and can take a significant amount of time in the order of tens of hours or several days.</p>
</section>
</section>
<section id="predict_ages.r" class="level4">
<h4 class="anchored" data-anchor-id="predict_ages.r"><em>03_Predict_ages.R</em></h4>
<p>With a successful age-depth model, the ages of individual levels are estimated. The Workflow will estimate age and the error estimate for each level, which will encapsulate 95% of all age posterior values (<em>upper</em> and <em>lower</em> boundary). As {<a href="http://andrewcparnell.github.io/Bchron/">Bchron</a>} uses a probabilistic model it is possible to obtain <em>possible</em> ages of each level. To do so, a number of ages (default = <code>1000</code>, see above) are drawn from the model posterior representing all the <em>possible</em> ages, and a series of quantiles of various values (<code>25</code>, <code>50</code>, <code>75</code>, etc.) are then calculated. The 50th quantile (<em>median</em>) is used as the final age of each level, and the 2.5th and 97.5th quantiles as upper and lower boundaries respectively. This results in the age estimate of each level including its error estimates. The whole matrix <em>levels by posterior drawn (possible age)</em> is saved as an <em>age uncertainty matrix</em> (<code>age_uncertainty</code> column). This whole process is completely automated and does not require any input from the user.</p>
</section>
<section id="save_ad_figures.r" class="level4">
<h4 class="anchored" data-anchor-id="save_ad_figures.r"><em>04_Save_AD_figures.R</em></h4>
<p>The visual representation of all age-depth models is saved as output for visual confirmation of successful model estimation. The files (as PDFs) are stored in the <code>/Outputs/Figures/Chronologies/</code> folder and split into subfolders defined by region. The properties of the figures (size of figures, font size, etc) can be altered in the Config file (<code>image_width</code>, <code>image_height</code>, <code>image_units</code>, <code>image_dpi</code>, <code>text_size</code>, <code>line_size</code>). They can be used for inspection of the age-depth curves to look for unrealistically large age estimates or error bars, hiatuses, or extreme extrapolations toward the present or the past.</p>
</section>
<section id="merge_chron_output.r" class="level4">
<h4 class="anchored" data-anchor-id="merge_chron_output.r"><em>05_Merge_chron_output.R</em></h4>
<p>The successfully predicted ages are linked with all the records from the various sources (Sections I-III). The individual levels of each record are then ordered by the predicted ages and the same order of levels is then applied to the tables with the pollen counts.</p>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
<section id="v.-harmonisation-05_harmonisation" class="level3">
<h3 class="anchored" data-anchor-id="v.-harmonisation-05_harmonisation"><span class="text-background-pink bold">V. Harmonisation</span>: <code>/05_Harmonisation/</code></h3>
<ul>
<li><code>Run_01_05.R</code> - run all scripts within this folder</li>
<li><a href="#harmonisation.r"><code>01_Harmonisation.R</code></a> - prepare all harmonisation tables and harmonise the raw counts.</li>
</ul>
<section id="note-on-harmonisation" class="level4">
<h4 class="anchored" data-anchor-id="note-on-harmonisation">Note on harmonisation</h4>
<p>The goal of taxonomic harmonisation is to standardise all site-level names to the same pollen morphotypes (set of pollen and spore morphotypes used for all pollen records) and thus reduce the effect of taxonomic uncertainty and nomenclatural complexity (See relevant literature in Appendix 1 of <a href="https://doi.org/10.1111/geb.13693">Flantua et al.&nbsp;2023</a>). For this purpose, a <em>harmonisation table</em> can be created that groups the morphotypes into the highest taxonomic level that is most likely to be identified by most of the pollen analysts.</p>
</section>
<section id="harmonisation.r" class="level4">
<h4 class="anchored" data-anchor-id="harmonisation.r"><em>01_Harmonisation.R</em></h4>
<p>First, the Workflow will check the <em>harmonisation regions</em> present in the data, defined by the shapefile (see <a href="#data-input">Data input</a> and <a href="#additional-data-preparation">Section III</a>), and confirm that there is one harmonisation table per region (a <a href="#data-storage"><strong><em>stop-check</em></strong></a> point, <a href="#figure-2figure-2">Fig. 2</a>). If any table is missing (or the Workflow is run for the first time), the Workflow will automatically create a harmonisation table per harmonisation region, with all the raw taxa names from all the records from within that region. Note that we refer here to “taxon names” for simplicity but the identification is often done at the level of family or genus, and are best referred to as morphotypes.</p>
<p>Each harmonisation table is created so that each taxon can have two columns:</p>
<ol type="i">
<li><p><code>taxon_name</code> which is the original name of the taxon (morphotype) formatted into a more computer-friendly format (<em>snake_case</em>)</p></li>
<li><p><code>level 1</code>, which should be used to merge various taxa (morphotypes) into harmonised taxonomic units, specific for the project.</p></li>
</ol>
<p>Note that in order to link the names to the original display in Neotoma, user can use the <code>taxa_reference_table</code> (see <a href="#additional-data-preparation">name cleaning process</a>).</p>
<p>The user can also define which taxa should be completely removed during the harmonisation process (marked as <code>delete</code>), in case of a taxonomic mistake or a palaeoecological proxy not of interest, e.g.&nbsp;spores). The user can add additional columns (e.g.&nbsp;<code>level_2</code>) and then specify which levels should be included by altering the argument <code>harm_name</code> when using the <code>RFossilpol::harmonise_all_regions()</code> function.</p>
<p>With these tables, each dataset is harmonised so that all taxa that belong to the same harmonised taxa (morphotypes) are summed together in each level - this process is applicable for both count and percentage data. This process includes automatic detection of successful pollen harmonisation by checking the total number of pollen grains before and after harmonisation (it can be turned off by changing the argument <code>pollen_grain_test</code> to <code>FALSE</code> when using the <code>RFossilpol::harmonise_all_regions()</code> function).</p>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
<section id="vi.-data-filtering-06_main_filtering" class="level3">
<h3 class="anchored" data-anchor-id="vi.-data-filtering-06_main_filtering"><span class="text-background-coral bold">VI. Data filtering</span>: <code>/06_Main_filtering/</code></h3>
<ul>
<li><code>Run_01_06.R</code> - run all scripts within this folder</li>
<li><a href="#01_level_filteringr"><code>01_Level_filtering.R</code></a> - filter out levels and records based on the user-defined criteria predefined in the Config file</li>
</ul>
<section id="note-on-data-filtering" class="level4">
<h4 class="anchored" data-anchor-id="note-on-data-filtering">Note on data filtering</h4>
<p>To obtain a comprehensive dataset compilation of multiple fossil pollen records, to increase its overall quality, and to answer research questions reliably, we recommend the user to further trim down the data selection by filtering out individual levels and/or whole records. All of these filtering criteria can be adjusted by the user in the Config file:</p>
<ul>
<li><p><code>filter_by_pollen_sum</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>20</strong>) - if <code>TRUE</code>, the Workflow will use the quantity of counted pollen grains at each level as a factor in determining the quality of the level.</p></li>
<li><p><code>filter_by_age_limit</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>24</strong>) - if <code>TRUE</code>, the Workflow will filter out records that do not span the user-defined time period (defined by <code>young_age</code> and <code>old_age</code> in <code>Regional_age_limits</code> table; see <a href="#iii.-initial-data-processing-03_merging_and_geographic_delineation">Section III</a>).</p></li>
<li><p><code>filter_by_extrapolation</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>25</strong>) - if <code>TRUE</code>, the Workflow will filter out levels based on the number of years between their age and the last chronology control point used for age-depth modelling (<code>chron_control_limits</code>).</p></li>
<li><p><code>filter_by_interest_region</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>27</strong>) - if <code>TRUE</code>, the Workflow will filter out levels that are older than <code>end_of_interest_period</code> (defined in <code>Regional_age_limits</code> table; see <a href="#iii.-initial-data-processing-03_merging_and_geographic_delineation">Section III</a>) to subsequently reduce processing time during follow-up analyses.</p></li>
<li><p><code>filter_by_number_of_levels</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>28</strong>) - if <code>TRUE</code>, the Workflow will filter out records based on the number of levels.</p></li>
</ul>
<p>In addition, two more options can be activated by the user:</p>
<ul>
<li><p><code>use_age_quantiles</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>30</strong>) - if <code>TRUE</code>, the Workflow will use the 95th age quantile (uncertainty of the level age) throughout the data filtration process, i.e.&nbsp;the age of the level will be assumed to be anywhere between the upper and lower boundary (see <a href="#predict_ages.r">Section IV</a>). This will result in a more stable dataset compilation between the different results of age-depth modelling (as a probabilistic result can output slightly different results each time they are run). However, the final dataset compilation may require some additional filtering before any analyses, as the 95th age quantile can span very long time periods.</p></li>
<li><p><code>use_bookend_level</code> (<a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>31</strong>) - if <code>TRUE</code>, the Workflow will leave one additional level beyond the oldest age of the user-defined time period. This will result in a <em>bookend</em> level, which can help to anchor information beyond the period of interest.</p></li>
</ul>
</section>
<section id="level_filtering.r" class="level4">
<h4 class="anchored" data-anchor-id="level_filtering.r"><em>01_Level_filtering.R</em></h4>
<section id="pollen-count-sum" class="level5">
<h5 class="anchored" data-anchor-id="pollen-count-sum">Pollen count sum</h5>
<p>The number of counted pollen grains at each level is an index of data quality. To obtain a reliable representation of the vegetation, researchers often aim to count more than <code>300</code> pollen grains (following Moore et al., 1991), but other recommendations may also have been followed (&gt;<code>150</code>; e.g.&nbsp;<a href="https://doi.org/10.1016/j.revpalbo.2019.104156">Djamali &amp; Cilleros, 2020</a>) and will vary with region and by scientific question (<a href="https://www.google.cz/books/edition/_/9wrDQgAACAAJ?hl=en&amp;sa=X&amp;ved=2ahUKEwiLnKaxsISMAxUb0gIHHfS_FjsQ8fIDegQIHxAJ">Birks &amp; Birks, 1980</a>). For example, to achieve a representative sample of the regional pollen pool, counts in Arctic records may only reach c.&nbsp;<code>100</code> grains per level, whereas counts in Mediterranean sites can be as high as <code>1000</code> (<a href="https://www.google.cz/books/edition/_/9wrDQgAACAAJ?hl=en&amp;sa=X&amp;ved=2ahUKEwiLnKaxsISMAxUb0gIHHfS_FjsQ8fIDegQIHxAJ">Birks &amp; Birks, 1980</a>, p.&nbsp;165), but the main determinant can also be the preference of the pollen analyst. Reasons for low numbers (&lt;<code>100</code>) are often mainly due to time constraints of the data contributor, but can also be natural depositional phenomena causing poor pollen preservation, such as low local pollen production in arctic or alpine environments. Given that statistical inferential power is proportional to sample size, we recommend defining a minimum number of total pollen grains in each level. Subsequently, whole records can be selected on the proportion of levels with a selected minimum number of pollen grains counted per level.</p>
<p>The user can select two different quantities of total pollen grains per level: a) minimum number (<code>min_n_grains</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>21</strong>) and b) acceptable number (<code>target_n_grains</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>22</strong>). All levels with total pollen grains below the minimum number will be filtered out. In addition, the whole record will only be accepted if <em>X</em>% (set by <code>percentage_samples</code>; default = <code>50</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>23</strong>) of all levels fulfils at least the acceptable number of pollen grains. This filtration criterion will only be used if <code>filter_by_pollen_sum</code> == <code>TRUE</code>.</p>
</section>
<section id="age-criteria" class="level5">
<h5 class="anchored" data-anchor-id="age-criteria">Age criteria</h5>
<p>As projects differ in their temporal focus, only a subset of records will be of interest to the particular project. Therefore, records that do not span a certain age period (from <code>young_age</code> to <code>old_age</code>; specified by the <code>Regional_age_limits</code> table, see <a href="#iii.-initial-data-processing-03_merging_and_geographic_delineation">Section III</a>) will be filtered out. This filtration criterion will only be used if <code>filter_by_age_limit</code> == <code>TRUE</code> in the Config file.</p>
</section>
<section id="level-age-extrapolation" class="level5">
<h5 class="anchored" data-anchor-id="level-age-extrapolation">Level age extrapolation</h5>
<p>Extrapolation of age inferences to samples beyond the set of chronology control points is another factor in quality control. Levels older than the oldest chronology control point have no other chronology control point to constrain the age inference, and therefore, have increasingly large uncertainty as the amount of extrapolation increases. To limit the use of levels based on large extrapolations, we recommend selecting a maximum extrapolation age, i.e.&nbsp;levels older than the selected age criterion (e.g.&nbsp;<code>5000</code> yr) from the last chronology control point are filtered out.</p>
<p>In order to limit the use of levels based on large extrapolations, the user can select the maximum extrapolation age (<code>maximum_age_extrapolation</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>26</strong>), i.e.&nbsp;levels older than the selected criterion from the last chronology control point will be filtered out. This filtration criterion will only be used if <code>filter_by_extrapolation</code> == <code>TRUE</code> in the Config file.</p>
</section>
<section id="interest-period" class="level5">
<h5 class="anchored" data-anchor-id="interest-period">Interest period</h5>
<p>The individual levels of a record outside of the <em>interest period</em> (<code>end_of_interest_period</code> specified by the <code>Regional_age_limits</code> table) will be filtered out as they do not provide additional information. This filtration criterion will only be used if <code>filter_by_interest_region</code> == <code>TRUE</code> in the Config file.</p>
</section>
<section id="number-of-levels" class="level5">
<h5 class="anchored" data-anchor-id="number-of-levels">Number of levels</h5>
<p>The total number of levels in a record is an important quality criterion for further use of such a record in a specific analysis. Records might have been sampled at low resolution (e.g.&nbsp;depth intervals &gt; 30 cm) leaving substantial unassessed gaps - and thus time periods - between levels. In addition, records with few levels will likely contribute poorly to studies focused on specific time periods (many non-value levels) and can cause unnecessary outlier values. Therefore, we recommend selecting a minimum number of levels within the time period of interest and use this as an additional criterion to filter out unwanted records. The user can select the minimum number of levels (<code>min_n_levels</code>, <a href="#figure-2figure-2">Fig. 2</a> - config criteria <strong>29</strong>) that records must have at the end of the filtration subroutine. This filtration criterion will only be used if <code>filter_by_number_of_levels</code> == <code>TRUE</code> in the Config file.</p>
<p><br></p>
<hr>
<p><br></p>
</section>
</section>
</section>
<section id="vii.-outputs-07_outputs" class="level3">
<h3 class="anchored" data-anchor-id="vii.-outputs-07_outputs"><span class="text-background-orange bold">VII. Outputs</span>: <code>/07_Outputs/</code></h3>
<ul>
<li><code>Run_01_07.R</code> - run all scripts within this folder</li>
<li><a href="#pollen_diagrams.r"><code>01_Pollen_diagrams.R</code></a> - save pollen diagrams for all records</li>
<li><a href="#save_assembly.r"><code>02_Save_assembly.R</code></a> - save data assembly with selected variables (columns)</li>
<li><a href="#save_references.r"><code>03_Save_references.R</code></a> - save reference and metatable</li>
</ul>
<section id="pollen_diagrams.r" class="level4">
<h4 class="anchored" data-anchor-id="pollen_diagrams.r"><em>01_Pollen_diagrams.R</em></h4>
<p>Pollen diagrams for all records will be created using the {<a href="https://cran.r-project.org/web/packages/rioja/rioja.pdf">rioja</a>} package. The harmonised data will be automatically transformed into relative proportion for plotting purposes. The pollen diagrams will be saved in the <code>/Outputs/Figures/Pollen_diagrams/</code> folder and split into sub-folders defined by <em>Region</em> (e.g., continent).</p>
<p>The <code>RFossilpol::plot_all_pollen_diagrams()</code> function will automatically produce a PDF of the pollen diagram split into several A4 pages and ready to be printed out. The y-axis is, by default, the age of the levels, but it can be altered to depth (by the <code>y_var</code> argument set to <code>"age"</code> or <code>"depth"</code>). The maximum number of taxa per page can be altered by the <code>max_taxa</code> argument (default = <code>20</code>). In addition, the function will automatically omit very rare taxa. Specifically, the <code>min_n_occur</code> argument will determine the minimum number of occurrences per record each taxon has to have to be plotted.</p>
</section>
<section id="save_assembly.r" class="level4">
<h4 class="anchored" data-anchor-id="save_assembly.r"><em>02_Save_assembly.R</em></h4>
<p>A ready-to-use, taxonomically harmonised and standardised compilation of fossil pollen data (ready for the analytical stage) is produced and saved in the <code>/Outputs/Data/</code> folder. The file is saved as a <em>tibble</em> (by {<a href="https://tibble.tidyverse.org/">tibble</a>} package from <a href="https://www.tidyverse.org/">tidyverse</a>) in <code>rds</code> format.</p>
<p>The user can select which columns (variables) should be present in the final data compilation by selecting <code>select_final_variables</code> == <code>TRUE</code> in the Config file. Here, the Workflow will interactively (in the R console) ask the user to specify if each variable should be included (Yes/No).</p>
</section>
<section id="save_references.r" class="level4">
<h4 class="anchored" data-anchor-id="save_references.r"><em>03_Save_references.R</em></h4>
<p>The workflow will save all metadata and citation information needed to create the dataset compilation. All outputs can be found in the <code>/Outputs/Meta_and_references/</code> folder. The function<code>RFossilpol::proc_save_references()</code> will do this automatically but it can be specified by the user, i.e.&nbsp;the user can specify what information should be saved using the <code>user_sel_variables</code> argument. By default this information contains:</p>
<ul>
<li><p><code>"meta_table"</code> - a <em>metadata table</em> (<code>data_assembly_meta.csv</code>) contains the following variables by default (note that this list may be altered by changing the final variables by <code>select_final_variables</code>):</p>
<ul>
<li>the list of all records in the final dataset compilation</li>
<li>geographical location</li>
<li>depositional environment</li>
<li>assigned continental region</li>
<li>assigned harmonisation region</li>
<li>final number of levels</li>
<li>number of chronology control points used for age-depth modelling</li>
<li>assigned calibration curve(s)</li>
<li>age limits of each record of each data source (Neotoma or other data source)</li>
<li>DOI (from Neotoma).</li>
</ul></li>
<li><p><code>"author_table"</code> - a <em>reference table</em> (<code>authors_meta.csv</code>) containing information about the datasets used, the main data contributor, and their contact information.</p></li>
<li><p><code>"affiliation_table"</code> - if an affiliation is provided with the data from sources other than Neotoma, the <em>affiliation table</em> (<code>affiliation_table</code>) is also exported linking affiliations and their authors.</p></li>
<li><p><code>"graphical_summary"</code> - a PDF (<code>graphical_summary*.pdf</code>) with three panel figures using <code>RFossilpol::plot_graphical_summary()</code> function (note that additional arguments can be passed to this function, see <code>?RFossilpol::plot_graphical_summary</code> for more information):</p>
<ol type="A">
<li>map - map of geographical location with each record represented as a point</li>
<li>count of data records- a lollipop plot with the number of records in each geographical group when assigned</li>
<li>age length - age limits of records, with each record represented by a single line</li>
</ol></li>
<li><p><code>"reproducibility_bundle"</code> - a zip file (<code>reproducibility_bundle.zip</code>) of the Config file, all <a href="#data-storage"><strong><em>stop-check</em></strong></a> CSV tables, and all shapefiles. The idea is to increase the reproducibility of the user´s workflow where ideally this zip file can be shared when publishing a publication with a project created using the FOSSILPOL Workflow. For reviewing purposes, the zip file can be shared and detailed feedback can be provided before publication.</p></li>
</ul>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with ❤️ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>